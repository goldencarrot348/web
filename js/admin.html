<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理后台 - GoldenCarrot 我的世界服务器</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        .admin-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 2rem;
            padding: 2rem;
        }

        .login-form {
            max-width: 400px;
            margin: 2rem auto;
            padding: 2rem;
            background: var(--white);
            border-radius: 10px;
            box-shadow: var(--shadow);
        }

        .admin-panel {
            display: none;
        }

        .admin-sidebar {
            background: var(--white);
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: var(--shadow);
            height: fit-content;
        }

        .admin-menu {
            list-style: none;
            padding: 0;
        }

        .admin-menu li {
            margin-bottom: 0.5rem;
        }

        .admin-menu a {
            display: block;
            padding: 0.8rem 1rem;
            color: var(--dark);
            text-decoration: none;
            border-radius: 5px;
            transition: var(--transition);
        }

        .admin-menu a:hover,
        .admin-menu a.active {
            background: var(--primary);
            color: var(--white);
        }

        .admin-content {
            background: var(--white);
            padding: 2rem;
            border-radius: 10px;
            box-shadow: var(--shadow);
            width: 100%;
            overflow-x: hidden;
        }

        .admin-card {
            background: var(--white);
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: var(--shadow);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--dark);
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: inherit;
        }

        .form-group textarea {
            min-height: 150px;
            resize: vertical;
        }

        .announcement-list,
        .event-list {
            margin-top: 1rem;
        }

        .announcement-item,
        .event-item {
            background: var(--light);
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 5px;
        }

        .btn-group {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .btn-edit,
        .btn-delete {
            padding: 0.3rem 0.8rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-edit {
            background: var(--primary);
            color: var(--white);
        }

        .btn-delete {
            background: #e74c3c;
            color: var(--white);
        }

        .image-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .image-preview img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 5px;
        }

        .btn-secondary {
            background: var(--secondary);
            color: var(--white);
            margin-left: 1rem;
        }

        #previewFrame {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }

        #previewFrame iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .preview-close {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: var(--white);
            color: var(--dark);
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1001;
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>GoldenCarrot 我的世界服务器管理后台</h1>
    </header>

    <div class="admin-container">
        <div class="login-form" id="loginForm">
            <h2>管理员登录</h2>
            <div class="form-group">
                <label for="username">用户名</label>
                <input type="text" id="username" required>
            </div>
            <div class="form-group">
                <label for="password">密码</label>
                <input type="password" id="password" required>
            </div>
            <button class="btn btn-primary" onclick="login()">登录</button>
        </div>

        <div class="admin-panel" id="adminPanel">
            <div class="admin-sidebar">
                <ul class="admin-menu">
                    <li><a href="#" data-section="pages" class="active">页面管理</a></li>
                    <li><a href="#" data-section="announcements">公告管理</a></li>
                    <li><a href="#" data-section="events">活动管理</a></li>
                    <li><a href="#" data-section="images">图片管理</a></li>
                    <li><a href="#" data-section="reports">举报管理</a></li>
                    <li><a href="#" data-section="donations">捐赠管理</a></li>
                    <li><a href="#" data-section="submissions">作品管理</a></li>
                </ul>
            </div>
            <div class="admin-content">
                <div id="section-pages" class="admin-card">
                    <h3>页面内容管理</h3>
                    <div class="form-group">
                        <label for="pageSelect">选择页面</label>
                        <select id="pageSelect" onchange="loadPageContent()">
                            <option value="index">首页</option>
                            <option value="faq">玩法介绍</option>
                            <option value="community">社区</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="pageTitle">页面标题</label>
                        <input type="text" id="pageTitle">
                    </div>
                    <div class="form-group">
                        <label for="pageContent">页面内容</label>
                        <textarea id="pageContent" style="min-height: 300px;"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="imageUpload">上传图片</label>
                        <input type="file" id="imageUpload" accept="image/*" multiple>
                        <div id="imagePreview" class="image-preview"></div>
                    </div>
                    <button class="btn btn-primary" onclick="savePage()">保存页面</button>
                    <button class="btn btn-secondary" onclick="previewPage()">预览</button>
                </div>

                <div id="section-announcements" class="admin-card" style="display: none;">
                    <h3>公告管理</h3>
                    <div class="form-group">
                        <label for="announcementTitle">公告标题</label>
                        <input type="text" id="announcementTitle">
                    </div>
                    <div class="form-group">
                        <label for="announcementContent">公告内容</label>
                        <textarea id="announcementContent"></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="saveAnnouncement()">保存公告</button>
                    <div class="announcement-list" id="announcementList"></div>
                </div>

                <div id="section-events" class="admin-card" style="display: none;">
                    <h3>活动管理</h3>
                    <div class="form-group">
                        <label for="eventTitle">活动标题</label>
                        <input type="text" id="eventTitle">
                    </div>
                    <div class="form-group">
                        <label for="eventDate">活动日期</label>
                        <input type="datetime-local" id="eventDate">
                    </div>
                    <div class="form-group">
                        <label for="eventDescription">活动描述</label>
                        <textarea id="eventDescription"></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="saveEvent()">保存活动</button>
                    <div class="event-list" id="eventList"></div>
                </div>
                <!-- 图片管理部分 -->
                <div id="section-images" class="admin-card" style="display: none;">
                    <h3>图片管理</h3>
                    <div class="form-group">
                        <label for="imageTitle">图片标题</label>
                        <input type="text" id="imageTitle">
                    </div>
                    <div class="form-group">
                        <label for="imageDescription">图片描述</label>
                        <textarea id="imageDescription"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="imageFile">选择图片</label>
                        <input type="file" id="imageFile" accept="image/*" onchange="previewImage(event)">
                        <img id="imagePreview" style="max-width: 200px; margin-top: 1rem; display: none;">
                    </div>
                    <button class="btn btn-primary" onclick="saveImage()">上传图片</button>
                    <div class="image-gallery" id="imageGallery"></div>
                </div>

                <!-- 举报管理部分 -->
                <div id="section-reports" class="admin-card" style="display: none;">
                    <h3>举报管理</h3>
                    <div class="form-group">
                        <label for="reportReporter">举报人</label>
                        <input type="text" id="reportReporter" placeholder="可匿名">
                    </div>
                    <div class="form-group">
                        <label for="reportReported">被举报人</label>
                        <input type="text" id="reportReported" required>
                    </div>
                    <div class="form-group">
                        <label for="reportViolation">违规类型</label>
                        <select id="reportViolation" required>
                            <option value="">请选择违规类型</option>
                            <option value="作弊">作弊</option>
                            <option value="辱骂">辱骂</option>
                            <option value="破坏">破坏</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="reportDescription">举报描述</label>
                        <textarea id="reportDescription" required></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="addReport()">提交举报</button>
                    <div class="report-list" id="reportList"></div>
                    <script>
                        // 加载举报列表
                        function loadReports() {
                            const reports = JSON.parse(localStorage.getItem('reports') || '[]');
                            const container = document.getElementById('reportList');
                            
                            if (!reports || reports.length === 0) {
                                container.innerHTML = '<p class="no-reports">暂无举报记录</p>';
                                return;
                            }
                            
                            container.innerHTML = reports.map(report => `
                                <div class="report-item">
                                    <div class="report-header">
                                        <h4>举报人: ${report.reporter || '匿名'} 举报 ${report.reported || '未知用户'}</h4>
                                        <span>${report.date ? new Date(report.date).toLocaleString() : '时间未知'}</span>
                                    </div>
                                    <div class="report-body">
                                        <p><strong>违规类型:</strong> ${report.violation || '未指定'}</p>
                                        <p><strong>描述:</strong> ${report.description || '无描述'}</p>
                                    </div>
                                    <div class="report-actions">
                                        <button class="btn-view" onclick="viewReportDetails(${report.id})" title="查看详情">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn-delete" onclick="deleteReport(${report.id})" title="删除">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            `).join('');
                        }
                        
                        // 添加举报
                        function addReport() {
                            const reporter = document.getElementById('reportReporter').value;
                            const reported = document.getElementById('reportReported').value;
                            const violation = document.getElementById('reportViolation').value;
                            const description = document.getElementById('reportDescription').value;
                            
                            if (!reported || !violation || !description) {
                                alert('请填写完整的举报信息！');
                                return;
                            }
                            
                            const report = {
                                id: Date.now(),
                                reporter,
                                reported,
                                violation,
                                description,
                                date: new Date().toISOString(),
                                status: 'pending'
                            };
                            
                            let reports = JSON.parse(localStorage.getItem('reports') || '[]');
                            reports.unshift(report);
                            localStorage.setItem('reports', JSON.stringify(reports));
                            
                            // 清空表单
                            document.getElementById('reportReporter').value = '';
                            document.getElementById('reportReported').value = '';
                            document.getElementById('reportViolation').value = '';
                            document.getElementById('reportDescription').value = '';
                            
                            loadReports();
                            alert('举报已提交！');
                        }
                        
                        // 查看举报详情
                        function viewReportDetails(id) {
                            const reports = JSON.parse(localStorage.getItem('reports') || '[]');
                            const report = reports.find(r => r.id === id);
                            
                            if (report) {
                                const modal = document.createElement('div');
                                modal.className = 'report-modal';
                                modal.innerHTML = `
                                    <div class="modal-content">
                                        <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                                        <h3>举报详情</h3>
                                        <p><strong>举报人:</strong> ${report.reporter || '匿名'}</p>
                                        <p><strong>被举报人:</strong> ${report.reported || '未知用户'}</p>
                                        <p><strong>违规类型:</strong> ${report.violation || '未指定'}</p>
                                        <p><strong>举报时间:</strong> ${new Date(report.date).toLocaleString()}</p>
                                        <p><strong>举报状态:</strong> ${report.status || '待处理'}</p>
                                        <div class="report-description">
                                            <h4>举报描述:</h4>
                                            <p>${report.description || '无描述'}</p>
                                        </div>
                                        <div class="modal-actions">
                                            <button class="btn btn-primary" onclick="updateReportStatus(${report.id}, 'processed')">标记为已处理</button>
                                            <button class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">关闭</button>
                                        </div>
                                    </div>
                                `;
                                document.body.appendChild(modal);
                            } else {
                                alert('未找到该举报记录！');
                            }
                        }
                        
                        // 更新举报状态
                        function updateReportStatus(id, status) {
                            let reports = JSON.parse(localStorage.getItem('reports') || '[]');
                            const reportIndex = reports.findIndex(r => r.id === id);
                            
                            if (reportIndex !== -1) {
                                reports[reportIndex].status = status;
                                localStorage.setItem('reports', JSON.stringify(reports));
                                loadReports();
                                alert('举报状态已更新！');
                                document.querySelector('.report-modal').remove();
                            }
                        }
                        
                        // 删除举报
                        function deleteReport(id) {
                            if (confirm('确定要删除这条举报吗？')) {
                                let reports = JSON.parse(localStorage.getItem('reports') || '[]');
                                reports = reports.filter(r => r.id !== id);
                                localStorage.setItem('reports', JSON.stringify(reports));
                                loadReports();
                                alert('举报已删除！');
                            }
                        }
                        
                        // 初始化加载举报列表
                        document.addEventListener('DOMContentLoaded', function() {
                            if (document.getElementById('reportList')) {
                                loadReports();
                            }
                        });
                    </script>
                </div>

                <div id="section-submissions" class="admin-card" style="display: none;">
                    <h3>玩家作品管理</h3>
                    <div class="form-group">
                        <label for="submissionPlayer">玩家名称</label>
                        <input type="text" id="submissionPlayer" required>
                    </div>
                    <div class="form-group">
                        <label for="submissionTitle">作品标题</label>
                        <input type="text" id="submissionTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="submissionDescription">作品描述</label>
                        <textarea id="submissionDescription" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="submissionImage">上传作品图片</label>
                        <input type="file" id="submissionImage" accept="image/*" onchange="previewSubmissionImage(event)">
                        <img id="submissionPreview" style="max-width: 200px; margin-top: 1rem; display: none;">
                    </div>
                    <button class="btn btn-primary" onclick="saveSubmission()">保存作品</button>
                    <div class="submission-list" id="submissionList"></div>
                </div>

                <div id="section-submissions" class="admin-card" style="display: none;">
                    <h3>玩家作品管理</h3>
                    <div class="form-group">
                        <label for="submissionPlayer">玩家名称</label>
                        <input type="text" id="submissionPlayer" required>
                    </div>
                    <div class="form-group">
                        <label for="submissionTitle">作品标题</label>
                        <input type="text" id="submissionTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="submissionDescription">作品描述</label>
                        <textarea id="submissionDescription" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="submissionImage">上传作品图片</label>
                        <input type="file" id="submissionImage" accept="image/*" onchange="previewSubmissionImage(event)">
                        <img id="submissionPreview" style="max-width: 200px; margin-top: 1rem; display: none;">
                    </div>
                    <button class="btn btn-primary" onclick="saveSubmission()">保存作品</button>
                    <div class="submission-list" id="submissionList"></div>
                </div>
                
                <script>
                    // 预览作品图片
                    function previewSubmissionImage(event) {
                        const input = event.target;
                        const preview = document.getElementById('submissionPreview');
                        
                        if (input.files && input.files[0]) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                preview.src = e.target.result;
                                preview.style.display = 'block';
                            }
                            reader.readAsDataURL(input.files[0]);
                        }
                    }
                    
                    // 保存作品
                    function saveSubmission() {
                        const player = document.getElementById('submissionPlayer').value;
                        const title = document.getElementById('submissionTitle').value;
                        const description = document.getElementById('submissionDescription').value;
                        const imageInput = document.getElementById('submissionImage');
                        
                        if (!player || !title || !description || !imageInput.files[0]) {
                            alert('请填写完整的作品信息并上传图片！');
                            return;
                        }
                        
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const submission = {
                                id: Date.now(),
                                player,
                                title,
                                description,
                                image: e.target.result,
                                date: new Date().toISOString(),
                                approved: false
                            };
                            
                            let submissions = JSON.parse(localStorage.getItem('submissions') || '[]');
                            submissions.unshift(submission);
                            localStorage.setItem('submissions', JSON.stringify(submissions));
                            
                            // 清空表单
                            document.getElementById('submissionPlayer').value = '';
                            document.getElementById('submissionTitle').value = '';
                            document.getElementById('submissionDescription').value = '';
                            document.getElementById('submissionImage').value = '';
                            document.getElementById('submissionPreview').style.display = 'none';
                            
                            loadSubmissions();
                            alert('作品已提交，等待管理员审核！');
                        };
                        reader.readAsDataURL(imageInput.files[0]);
                    }
                    
                    // 加载作品列表
                    function loadSubmissions() {
                        const submissions = JSON.parse(localStorage.getItem('submissions') || '[]');
                        const container = document.getElementById('submissionList');
                        
                        if (!submissions || submissions.length === 0) {
                            container.innerHTML = '<p class="no-submissions">暂无作品提交</p>';
                            return;
                        }
                        
                        container.innerHTML = submissions.map(sub => `
                            <div class="submission-item">
                                <div class="submission-header">
                                    <h4>${sub.player} 提交: ${sub.title}</h4>
                                    <span>${new Date(sub.date).toLocaleString()}</span>
                                    <span class="status ${sub.approved ? 'approved' : 'pending'}>">
                                        ${sub.approved ? '已审核' : '待审核'}
                                    </span>
                                </div>
                                <div class="submission-body">
                                    <img src="${sub.image}" alt="${sub.title}" style="max-width: 200px;">
                                    <p>${sub.description}</p>
                                </div>
                                <div class="submission-actions">
                                    <button class="btn-approve" onclick="approveSubmission(${sub.id})" title="批准">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="btn-delete" onclick="deleteSubmission(${sub.id})" title="删除">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        `).join('');
                    }
                    
                    // 批准作品
                    function approveSubmission(id) {
                        let submissions = JSON.parse(localStorage.getItem('submissions') || '[]');
                        const index = submissions.findIndex(s => s.id === id);
                        
                        if (index !== -1) {
                            submissions[index].approved = true;
                            localStorage.setItem('submissions', JSON.stringify(submissions));
                            loadSubmissions();
                            alert('作品已批准！');
                        }
                    }
                    
                    // 删除作品
                    function deleteSubmission(id) {
                        if (confirm('确定要删除这个作品吗？')) {
                            let submissions = JSON.parse(localStorage.getItem('submissions') || '[]');
                            submissions = submissions.filter(s => s.id !== id);
                            localStorage.setItem('submissions', JSON.stringify(submissions));
                            loadSubmissions();
                            alert('作品已删除！');
                        }
                    }
                    
                    // 初始化加载作品列表
                    document.addEventListener('DOMContentLoaded', function() {
                        if (document.getElementById('submissionList')) {
                            loadSubmissions();
                        }
                    });
                </script>
                
                <div id="section-donations" class="admin-card" style="display: none;">
                    <h3>捐赠管理</h3>
                    <div class="form-group">
                        <label for="donationPlayerName">玩家名称</label>
                        <input type="text" id="donationPlayerName" required>
                    </div>
                    <div class="form-group">
                        <label for="donationAmount">捐赠金额</label>
                        <input type="number" id="donationAmount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="donationDate">捐赠时间</label>
                        <input type="datetime-local" id="donationDate" required>
                    </div>
                    <button class="btn btn-primary" onclick="addDonation()">添加捐赠记录</button>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>玩家名称</th>
                                <th>捐赠金额</th>
                                <th>捐赠时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="donationTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="previewFrame">
        <button class="preview-close" onclick="closePreview()">关闭预览</button>
        <iframe id="previewIframe"></iframe>
    </div>

    <script>
        // 模拟管理员账号
        const ADMIN_USERNAME = 'admin';
        // 存储的是密码的哈希值而非明文密码
        const ADMIN_PASSWORD_HASH = '7f2d7c8b9e0f1a2d3c4b5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6'; // Tbc650388的哈希值
        const ADMIN_SALT = 'GoldenCarrot_Salt_2024_Secure';
        const MAX_LOGIN_ATTEMPTS = 3;
        const LOCKOUT_TIME = 10 * 60 * 1000; // 10分钟
        let failedAttempts = 0;
        let lastFailedTime = 0;

        // 使用SHA-256加密密码
        async function hashPassword(password, salt) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password + salt);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }
        
        // 登录功能
        async function login() {
            // 检查是否处于锁定状态
            const now = Date.now();
            if (failedAttempts >= MAX_LOGIN_ATTEMPTS && (now - lastFailedTime) < LOCKOUT_TIME) {
                const remainingTime = Math.ceil((LOCKOUT_TIME - (now - lastFailedTime)) / 60000);
                alert(`密码错误次数过多，请${remainingTime}分钟后再试！`);
                return;
            }
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // 使用存储的盐值计算输入密码的哈希值
            const hashedPassword = await hashPassword(password, ADMIN_SALT);
            
            // 直接与存储的哈希值比较，而不是重新计算存储密码的哈希值
            if (username === ADMIN_USERNAME && hashedPassword === ADMIN_PASSWORD_HASH) {
                failedAttempts = 0;
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                loadData();
            } else {
                failedAttempts++;
                lastFailedTime = Date.now();
                if (failedAttempts >= MAX_LOGIN_ATTEMPTS) {
                    alert('密码错误次数过多，账号将被锁定10分钟！');
                } else {
                    alert(`用户名或密码错误！剩余尝试次数：${MAX_LOGIN_ATTEMPTS - failedAttempts}`);
                }
            }
        }

        // 保存公告
        function saveAnnouncement() {
            const title = document.getElementById('announcementTitle').value;
            const content = document.getElementById('announcementContent').value;

            if (!title || !content) {
                alert('请填写完整的公告信息！');
                return;
            }

            // 检查是否存在重复公告
            let announcements = JSON.parse(localStorage.getItem('announcements') || '[]');
            const isDuplicate = announcements.some(a => a.title === title && a.content === content);
            if (isDuplicate) {
                alert('该公告已存在！');
                return;
            }

            const announcement = {
                id: Date.now(),
                title,
                content,
                date: new Date().toISOString()
            };

            // 限制公告数量，保持最新的10条
            announcements.unshift(announcement);
            if (announcements.length > 10) {
                announcements = announcements.slice(0, 10);
            }
            
            localStorage.setItem('announcements', JSON.stringify(announcements));
            
            // 更新community.html中的公告列表
            updateCommunityPage();

            document.getElementById('announcementTitle').value = '';
            document.getElementById('announcementContent').value = '';
            loadAnnouncements();
            alert('公告发布成功！');
        }

        // 保存活动
        function saveEvent() {
            const title = document.getElementById('eventTitle').value;
            const date = document.getElementById('eventDate').value;
            const description = document.getElementById('eventDescription').value;

            if (!title || !date || !description) {
                alert('请填写完整的活动信息！');
                return;
            }

            // 检查是否存在重复活动
            let events = JSON.parse(localStorage.getItem('events') || '[]');
            const isDuplicate = events.some(e => e.title === title && e.date === date);
            if (isDuplicate) {
                alert('该活动已存在！');
                return;
            }

            const event = {
                id: Date.now(),
                title,
                date,
                description
            };

            // 限制活动数量，保持最新的10条
            events.unshift(event);
            if (events.length > 10) {
                events = events.slice(0, 10);
            }
            
            localStorage.setItem('events', JSON.stringify(events));
            updateCommunityPage();

            document.getElementById('eventTitle').value = '';
            document.getElementById('eventDate').value = '';
            document.getElementById('eventDescription').value = '';
            loadEvents();
            alert('活动发布成功！');
        }

        // 删除公告
        function deleteAnnouncement(id) {
            if (confirm('确定要删除这条公告吗？')) {
                let announcements = JSON.parse(localStorage.getItem('announcements') || '[]');
                announcements = announcements.filter(a => a.id !== id);
                localStorage.setItem('announcements', JSON.stringify(announcements));
                
                // 更新community.html中的公告列表
                updateCommunityPage();
                
                loadAnnouncements();
                alert('公告已删除！');
            }
        }

        // 删除活动
        function deleteEvent(id) {
            if (confirm('确定要删除这个活动吗？')) {
                let events = JSON.parse(localStorage.getItem('events') || '[]');
                events = events.filter(e => e.id !== id);
                localStorage.setItem('events', JSON.stringify(events));
                updateCommunityPage();
                loadEvents();
                alert('活动已删除！');
            }
        }

        // 加载公告列表
        function loadAnnouncements() {
            const announcements = JSON.parse(localStorage.getItem('announcements') || '[]');
            const container = document.getElementById('announcementList');
            container.innerHTML = announcements.map(announcement => `
                <div class="announcement-item">
                    <h4>${announcement.title}</h4>
                    <p>${announcement.content}</p>
                    <small>${new Date(announcement.date).toLocaleString()}</small>
                    <div class="btn-group">
                        <button class="btn-edit" onclick="editAnnouncement(${announcement.id})">编辑</button>
                        <button class="btn-delete" onclick="deleteAnnouncement(${announcement.id})">删除</button>
                    </div>
                </div>
            `).join('');
        }

        // 加载活动列表
        function loadEvents() {
            const events = JSON.parse(localStorage.getItem('events') || '[]');
            const container = document.getElementById('eventList');
            container.innerHTML = events.map(event => `
                <div class="event-item">
                    <h4>${event.title}</h4>
                    <p>${event.description}</p>
                    <small>${new Date(event.date).toLocaleString()}</small>
                    <div class="btn-group">
                        <button class="btn-edit" onclick="editEvent(${event.id})">编辑</button>
                        <button class="btn-delete" onclick="deleteEvent(${event.id})">删除</button>
                    </div>
                </div>
            `).join('');
        }

        // 更新社区页面的公告和活动
        function updateCommunityPage() {
            const announcements = JSON.parse(localStorage.getItem('announcements') || '[]');
            const events = JSON.parse(localStorage.getItem('events') || '[]');
            const communityContent = {
                announcements: announcements,
                events: events
            };
            localStorage.setItem('community_content', JSON.stringify(communityContent));
        }

        // 编辑公告
        function editAnnouncement(id) {
            const announcements = JSON.parse(localStorage.getItem('announcements') || '[]');
            const announcement = announcements.find(a => a.id === id);
            if (announcement) {
                document.getElementById('announcementTitle').value = announcement.title;
                document.getElementById('announcementContent').value = announcement.content;
                // 删除原公告
                deleteAnnouncement(id);
            }
        }

        // 编辑活动
        function editEvent(id) {
            const events = JSON.parse(localStorage.getItem('events') || '[]');
            const event = events.find(e => e.id === id);
            if (event) {
                document.getElementById('eventTitle').value = event.title;
                document.getElementById('eventDate').value = event.date;
                document.getElementById('eventDescription').value = event.description;
                // 删除原活动
                deleteEvent(id);
            }
        }

        // 初始化标签页切换
        function initializeTabSwitching() {
            const menuLinks = document.querySelectorAll('.admin-menu a');
            const adminCards = document.querySelectorAll('.admin-card');
            
            menuLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const sectionId = this.getAttribute('data-section');
                    
                    // 更新菜单激活状态
                    menuLinks.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    
                    // 更新内容区域显示
                    adminCards.forEach(card => {
                        if (card.id === `section-${sectionId}` || 
                            (sectionId === 'pages' && !card.id)) {
                            card.style.display = 'block';
                        } else {
                            card.style.display = 'none';
                        }
                    });
                });
            });
            
            // 初始化时显示页面管理部分
            menuLinks[0].click();
        }

        // 加载所有数据
        function loadData() {
            loadAnnouncements();
            loadEvents();
            loadPageContent();
            loadDonations();
            loadReports();
            initializeTabSwitching();
            // 初始化时同步一次数据到社区页面
            updateCommunityPage();
        }

        // 加载举报列表
        function loadReports() {
            const reports = JSON.parse(localStorage.getItem('reports') || '[]');
            const container = document.getElementById('reportList');
            container.innerHTML = reports.map(report => `
                <div class="report-item">
                    <h4>${report.playerName}</h4>
                    <p>${report.reportContent}</p>
                    <small>${new Date(report.date).toLocaleString()}</small>
                    <div class="btn-group">
                        <button class="btn-delete" onclick="deleteReport(${report.id})">删除</button>
                    </div>
                </div>
            `).join('');
        }

        // 删除举报
        function deleteReport(id) {
            if (confirm('确定要删除这条举报吗？')) {
                let reports = JSON.parse(localStorage.getItem('reports') || '[]');
                reports = reports.filter(r => r.id !== id);
                localStorage.setItem('reports', JSON.stringify(reports));
                loadReports();
                alert('举报已删除！');
            }
        }

        // 加载举报邮箱
        function loadReportEmail() {
            const email = localStorage.getItem('reportEmail') || '';
            document.getElementById('reportEmail').value = email;
        }

        // 加载页面内容
        function loadPageContent() {
            const page = document.getElementById('pageSelect').value;
            const content = JSON.parse(localStorage.getItem(`page_${page}`) || '{}');
            document.getElementById('pageTitle').value = content.title || '';
            document.getElementById('pageContent').value = content.content || '';
            document.getElementById('imagePreview').innerHTML = (content.images || []).map(img => 
                `<img src="${img}" alt="预览图片">`
            ).join('');
        }

        // 保存页面内容
        function savePage() {
            const page = document.getElementById('pageSelect').value;
            const title = document.getElementById('pageTitle').value;
            const content = document.getElementById('pageContent').value;
            const images = Array.from(document.getElementById('imagePreview').getElementsByTagName('img')).map(img => img.src);

            if (!title || !content) {
                alert('请填写完整的页面信息！');
                return;
            }

            const pageData = { title, content, images };
            localStorage.setItem(`page_${page}`, JSON.stringify(pageData));
            alert('页面保存成功！');
        }

        // 预览页面
        function previewPage() {
            const page = document.getElementById('pageSelect').value;
            document.getElementById('previewFrame').style.display = 'block';
            document.getElementById('previewIframe').src = `${page}.html`;
        }

        // 关闭预览
        function closePreview() {
            document.getElementById('previewFrame').style.display = 'none';
        }

        // 图片预览
        function previewImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('imagePreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        // 保存图片
        function saveImage() {
            const title = document.getElementById('imageTitle').value;
            const description = document.getElementById('imageDescription').value;
            const preview = document.getElementById('imagePreview');

            if (!title || !description || !preview.src) {
                alert('请填写完整的图片信息！');
                return;
            }

            const image = {
                id: Date.now(),
                title: title,
                description: description,
                url: preview.src,
                uploadTime: new Date().toISOString()
            };

            let images = JSON.parse(localStorage.getItem('images') || '[]');
            images.push(image);
            localStorage.setItem('images', JSON.stringify(images));

            // 清空表单
            document.getElementById('imageTitle').value = '';
            document.getElementById('imageDescription').value = '';
            document.getElementById('imageFile').value = '';
            preview.style.display = 'none';

            loadImages();
            alert('图片上传成功！');
        }

        // 加载图片列表
        function loadImages() {
            const images = JSON.parse(localStorage.getItem('images') || '[]');
            const gallery = document.getElementById('imageGallery');
            gallery.innerHTML = images.map(image => `
                <div class="gallery-item">
                    <img src="${image.url}" alt="${image.title}">
                    <div class="gallery-info">
                        <h4>${image.title}</h4>
                        <p>${image.description}</p>
                        <small>${new Date(image.uploadTime).toLocaleString()}</small>
                    </div>
                    <button class="btn-delete" onclick="deleteImage(${image.id})">删除</button>
                </div>
            `).join('');
        }

        // 删除图片
        function deleteImage(id) {
            if (confirm('确定要删除这张图片吗？')) {
                let images = JSON.parse(localStorage.getItem('images') || '[]');
                images = images.filter(img => img.id !== id);
                localStorage.setItem('images', JSON.stringify(images));
                loadImages();
                alert('图片已删除！');
            }
        }

        // 添加新的捐赠记录
        function addDonation() {
            const playerName = document.getElementById('donationPlayerName').value;
            const amount = parseFloat(document.getElementById('donationAmount').value);
            const date = document.getElementById('donationDate').value;
        
            if (!playerName || !amount || !date) {
                alert('请填写完整的捐赠信息！');
                return;
            }
        
            let donations = JSON.parse(localStorage.getItem('donations') || '[]');
            const donation = {
                id: Date.now(),
                playerName,
                amount,
                date
            };
        
            donations.push(donation);
            // 按捐赠金额从高到低排序
            donations.sort((a, b) => b.amount - a.amount);
            localStorage.setItem('donations', JSON.stringify(donations));
            loadDonations();
            clearDonationForm();
            alert('捐赠记录添加成功！');
        }
        
        // 编辑捐赠记录
        function editDonation(id) {
            const donations = JSON.parse(localStorage.getItem('donations') || '[]');
            const donation = donations.find(d => d.id === id);
            if (donation) {
                document.getElementById('donationPlayerName').value = donation.playerName;
                document.getElementById('donationAmount').value = donation.amount;
                document.getElementById('donationDate').value = donation.date;
                // 删除原记录
                deleteDonation(id);
            }
        }
        
        // 删除捐赠记录
        function deleteDonation(id) {
            if (confirm('确定要删除这条捐赠记录吗？')) {
                let donations = JSON.parse(localStorage.getItem('donations') || '[]');
                donations = donations.filter(d => d.id !== id);
                localStorage.setItem('donations', JSON.stringify(donations));
                loadDonations();
                alert('捐赠记录已删除！');
            }
        }

        // 加载捐赠记录列表
        function loadDonations() {
            const donations = JSON.parse(localStorage.getItem('donations') || '[]');
            const tbody = document.getElementById('donationTableBody');
            tbody.innerHTML = donations.map(donation => `
                <tr>
                    <td>${donation.playerName}</td>
                    <td>${donation.amount}</td>
                    <td>${new Date(donation.date).toLocaleString()}</td>
                    <td>
                        <button class="btn-edit" onclick="editDonation(${donation.id})">编辑</button>
                        <button class="btn-delete" onclick="deleteDonation(${donation.id})">删除</button>
                    </td>
                </tr>
            `).join('');
        }

        // 清空捐赠表单
        function clearDonationForm() {
            document.getElementById('donationPlayerName').value = '';
            document.getElementById('donationAmount').value = '';
            document.getElementById('donationDate').value = '';
        }
    </script>
</body>
</html>